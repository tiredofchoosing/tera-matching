<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Battleground matching</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
<% let isEmpty = Object.values(data).length === 0 %>
<% if (isEmpty) { %>
<div id="main">
	<h2 class="empty">–°–ø–∏—Å–æ–∫ –ø–æ–¥–±–æ—Ä–∞ –ø—É—Å—Ç üò¥</h2>
</div>
<% } else { %>
<div id="main">
	<div class="navigation">
		<div class="navigation-search">
			<span class="search-heading">üîç</span>
			<input type="text" id="searchName" class="searchName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞—Ä–µ–Ω—ã">
			<input type="text" id="searchMinLevel" class="searchMinLevel" placeholder="–£—Ä–æ–≤–µ–Ω—å [ 70 / 65+ / 69- / 20-40 ]" title="–£—Ä–æ–≤–µ–Ω—å [ 70 / 65+ / 69- / 20-40 ]">
		</div>
		<div class="navigation-sort">
			<span class="sort-heading">üîÄ</span>
			<select id="sort" class="sort">
				<option value="minLevelDesc">—É—Ä–æ–≤–µ–Ω—å (—É–±—ã–≤–∞–Ω–∏–µ)</option>
				<option value="minLevelAsc">—É—Ä–æ–≤–µ–Ω—å (–≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ)</option>
				<option value="nameDesc">–Ω–∞–∑–≤–∞–Ω–∏–µ (—É–±—ã–≤–∞–Ω–∏–µ)</option>
				<option value="nameAsc">–Ω–∞–∑–≤–∞–Ω–∏–µ (–≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ)</option>
				<option value="playersDesc" selected="selected">–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (—É–±—ã–≤–∞–Ω–∏–µ)</option>
				<option value="playersAsc">–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (–≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ)</option>
			</select>
			<button id="toggleDetails" class="toggleDetails" value="true">–°–≤–µ—Ä–Ω—É—Ç—å / –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫</button>
			<button id="clearNavigation" class="clearNavigation">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ</button>
		</div>
	</div>
    <div id="dungeon-list">
        <% for(let dungeonId in data) { %>
			<% let dungeon = data[dungeonId]; dungeonProps = battlegroundsInfo[dungeonId]; %>
			<details open class="dungeon-details">
				<summary class="dungeon-summary">
					<span class="dungeon-lvl"><%= dungeonProps.minLevel %></span>
					<span class="dungeon-name"><%= dungeonProps.name %></span>
					<% let countDmg = 0; dungeon.parties.forEach(p => countDmg += p.players.filter(p1 => p1.role === 1).length); %>
					<% let countHeal = 0; dungeon.parties.forEach(p => countHeal += p.players.filter(p1 => p1.role === 2).length); %>
					<span class="dungeon-players"><%=countDmg %><%= roles[1] %> | <%= countHeal %><%= roles[2] %></span>
				</summary>
				<% dungeon.parties.forEach(party => { %>
					<details class="party-details">
						<summary class="party-summary">
							<% Object.keys(party.players).forEach(id => { %>
								<% let player = party.players[id]; %>
								<span title="<%= classes[lang][player.class] %> - <%= player.level %>">
								<%= (player.isLeaderRequired) ? 'üëë' : '' %>
								<%= roles[player.role] %>
								<%= player.name %>
								<%= (parseInt(id, 10) + 1 !== party.players.length) ? '|' : '' %>
								</span>
							<% });%>
						</summary>
						<% Object.keys(party.players).forEach(id => { %>
							<p class="party-detailed-content">
								<% let player = party.players[id]; %>
								<%= (player.isLeaderRequired) ? 'üëë' : '' %>
								[<%= classes[lang][player.class] %>
								<%= player.level %>
								<%= roles[player.role] %>]
								<%= player.name %>
							</p>
						<% });%>
					</details>
				<% });%>
			</details>
        <% };%>
    </div>
</div>
<script>
	document.addEventListener('DOMContentLoaded', function() {
		let searchNameInput = document.getElementById('searchName');
		let searchMinLevelInput = document.getElementById('searchMinLevel');
		let sortSelect = document.getElementById('sort');
		let dungeonList = document.getElementById('dungeon-list');
		let dungeons = Array.from(dungeonList.getElementsByClassName('dungeon-details'));
		let toggleDetailsButton = document.getElementById('toggleDetails');
		let clearNavigationButton = document.getElementById('clearNavigation');
		let searchInputs = [searchNameInput, searchMinLevelInput];
		const defaultSelectIndex = 4;

		function updateNavigation() {
			sortSelect.dispatchEvent(new Event('change'));
			filterDungeons();
		}

		toggleDetailsButton.addEventListener('click', function() {
			let isOpen = toggleDetailsButton.value === "true";
			toggleDetailsButton.value = !isOpen;

			dungeons.forEach(function(detail) {
				detail.open = !isOpen;
			});
		});

		clearNavigationButton.addEventListener('click', function() {
			searchInputs.forEach(function(element) {
				element.value = '';
			});
			sortSelect.selectedIndex = defaultSelectIndex;
			updateNavigation();
		});

		function filterDungeons() {
			let searchNameVal = searchNameInput.value.toLowerCase();
			let searchMinLevelVal = searchMinLevelInput.value;
			
			if (window.sessionStorage) {
				searchInputs.forEach(function(element) {
					let id = element.getAttribute('id');
					sessionStorage.setItem(id, element.value);
				});
			}

			dungeons.forEach(function(dungeon) {
				let name = dungeon.getElementsByClassName('dungeon-name')[0].textContent;
				let minLevel = parseInt(dungeon.getElementsByClassName('dungeon-lvl')[0].textContent);

				let show = name.toLowerCase().includes(searchNameVal) &&
					checkLevel(minLevel, searchMinLevelVal);

				dungeon.style.display = show ? '' : 'none';
			});
		}

		function checkLevel(level, searchVal) {
			if (searchVal === '') {
				return true;
			} else if (searchVal.endsWith('+')) {
				return level >= parseInt(searchVal);
			} else if (searchVal.endsWith('-')) {
				return level <= parseInt(searchVal);
			} else if (searchVal.includes('-')) {
				let [min, max] = searchVal.split('-').map(Number);
				return level >= min && level <= max;
			} else {
				return level === parseInt(searchVal);
			}
		}

		searchNameInput.addEventListener('input', filterDungeons);
		searchMinLevelInput.addEventListener('input', filterDungeons);

		sortSelect.addEventListener('change', function() {
			let sortVal = this.value;
			let sortIndex = this.selectedIndex;

			if (window.sessionStorage) {
				let id = sortSelect.getAttribute('id');
				sessionStorage.setItem(id, sortIndex);
			}

			dungeons.sort(function(a, b) {
				let minLevelA = parseInt(a.getElementsByClassName('dungeon-lvl')[0].textContent);
				let minLevelB = parseInt(b.getElementsByClassName('dungeon-lvl')[0].textContent);
				let nameA = a.getElementsByClassName('dungeon-name')[0].textContent;
				let nameB = b.getElementsByClassName('dungeon-name')[0].textContent;
				let playersA = a.getElementsByClassName('party-detailed-content').length;
				let playersB = b.getElementsByClassName('party-detailed-content').length;

				switch(sortVal) {
					case 'minLevelDesc':
						return minLevelB - minLevelA;
					case 'minLevelAsc':
						return minLevelA - minLevelB;
					case 'nameDesc':
						return nameB.localeCompare(nameA);
					case 'nameAsc':
						return nameA.localeCompare(nameB);
					case 'playersDesc':
						return playersB - playersA;
					case 'playersAsc':
						return playersA - playersB;
				}
			});
			dungeons.forEach(function(dungeon) {
				dungeonList.appendChild(dungeon);
			});
		});

		if (window.sessionStorage) {
			searchInputs.forEach(function(element) {
				let id = element.getAttribute('id');
				if (sessionStorage.getItem(id) != undefined && sessionStorage.getItem(id) != null) {
					element.value = sessionStorage.getItem(id);
				}
			});

			let sortId = sortSelect.getAttribute('id');
			if (sessionStorage.getItem(sortId) != undefined && sessionStorage.getItem(sortId) != null) {
				sortSelect.selectedIndex = sessionStorage.getItem(sortId);
			}
		}

		updateNavigation();
	});
</script>
<% };%>
</body>
</html>